trigger:
  paths:
    include:
      - samreglib/testData/**

pool:
  name: Self-hosted

steps:
- script: |
    echo Current directory: %CD%
    if not exist samreglib\utils\processXML\processXML.py (
      echo ERROR: samreglib\utils\processXML\processXML.py not found
      exit /b 1
    )
    for /f "tokens=*" %%f in ('git diff --name-only --diff-filter=A HEAD^ HEAD 2^>nul') do (
      if exist "%%f" (
        if "%%f"=="samreglib\testData\*.xml" (
          echo Processing %%f
          python3 samreglib\utils\processXML\processXML.py "%%f"
        )
      )
    )
  displayName: 'Process XML files'
  workingDirectory: $(System.DefaultWorkingDirectory)

- script: |
    echo Current directory: %CD%
    git status --porcelain | findstr . >nul || (echo No changes to commit && exit /b 0)
    git config --global user.email "pipeline@example.com"
    git config --global user.name "Pipeline"
    git add .
    git commit -m "Converted XML to JSON"
    git push origin HEAD:$(git rev-parse --abbrev-ref HEAD)
  displayName: 'Commit and push JSON'
  workingDirectory: $(System.DefaultWorkingDirectory)
