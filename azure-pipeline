trigger:
  paths:
    include:
      - samreglib/testData/*/*.xml

pool:
  name: 'Self-hosted'

steps:
- checkout: self
  fetchDepth: 2  # Fetches the last two commits to compare changes

# Windows: Use PowerShell
- task: PowerShell@2
  condition: eq(variables['Agent.OS'], 'Windows_NT')
  inputs:
    targetType: 'inline'
    script: |
          changed_xml_files=$(git show --name-only --pretty=format: HEAD | grep -E 'samreglib/testData/[^/]+/[^/]+\.xml$')
    echo "Changed XML files: $changed_xml_files"
    if [ -n "$changed_xml_files" ]; then
      for file in $changed_xml_files; do
        python samreglib/utils/processXML/process_xml.py "$file"
        json_file="${file%.xml}.json"
        git rm "$file"
        git add "$json_file"
      done
      git config --global user.email "pipeline@azure.com"
      git config --global user.name "Azure Pipeline"
      git commit -m "Processed XML files to JSON"
      git push https://$(System.AccessToken)@dev.azure.com/yourorg/yourproject/_git/yourrepo
    else
      echo "No XML files changed. Skipping processing."
    fi
  displayName: 'Process XML files (Windows)'

# Linux: Use Bash
- task: Bash@3
  condition: eq(variables['Agent.OS'], 'Linux')
  inputs:
    targetType: 'inline'
    script: |
      changed_xml_files=$(git show --name-only --pretty=format: HEAD | grep -E 'samreglib/testData/[^/]+/[^/]+\.xml$')
      if [ -n "$changed_xml_files" ]; then
        for file in $changed_xml_files; do
          python samreglib/utils/processXML/process_xml.py "$file"
          json_file="${file%.xml}.json"
          git rm "$file"
          git add "$json_file"
        done
        git config --global user.email "pipeline@azure.com"
        git config --global user.name "Azure Pipeline"
        git commit -m "Processed XML files to JSON"
        git push https://$(System.AccessToken)@dev.azure.com/yourorg/yourproject/_git/yourrepo
      else
        echo "No XML files changed."
      fi
  displayName: 'Process XML files (Linux)'
