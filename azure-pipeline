trigger:
  paths:
    include:
      - testData/**

pool:
  name: Self-hosted

steps:
- bash: |
    python3 --version || { echo "Python3 not found"; exit 1; }
    pip3 install -r requirements.txt || echo "No requirements.txt, continuing"
  displayName: 'Install dependencies'
  workingDirectory: $(System.DefaultWorkingDirectory)

- bash: |
    echo "Current directory: $(pwd)"
    git --version || { echo "Git not found"; exit 1; }
    added_files=$(git diff --name-only --diff-filter=A HEAD^ HEAD 2>/dev/null) || exit 0
    [ -z "$added_files" ] && { echo "No files added"; exit 0; }
    for file in $added_files; do
      if [[ $file == samreglib/testData/*/*.xml ]]; then
        echo "Processing $file"
        [ -f "$file" ] || { echo "File $file not found"; continue; }
        python3 utils/processXML/processXML.py "$file" || echo "Failed to process $file"
      fi
    done
    echo "JSON files:"
    ls samreglib/testData/*/*.json 2>/dev/null || echo "No JSON files"
  displayName: 'Process XML files'
  workingDirectory: $(System.DefaultWorkingDirectory)

- bash: |
    echo "Pending changes:"
    git status --porcelain || exit 1
    git status --porcelain | grep -q . || { echo "No changes to commit"; exit 0; }
    git config --global user.email "pipeline@example.com"
    git config --global user.name "Pipeline"
    git add .
    git commit -m "Converted XML to JSON" || exit 1
    git push origin HEAD:$(git rev-parse --abbrev-ref HEAD) || exit 1
  displayName: 'Commit and push JSON'
  workingDirectory: $(System.DefaultWorkingDirectory)
