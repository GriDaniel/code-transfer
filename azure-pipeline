trigger:
  paths:
    include:
      - samreglib/testData/*/*.xml

pool:
  name: 'Self-hosted'

steps:
- checkout: self
  fetchDepth: 0

- powershell: |
    $added_files = git diff --name-only --diff-filter=A HEAD^ HEAD | Where-Object { $_ -match '^samreglib/testData/[^/]+/[^/]+\.xml$' }
    if ($added_files) {
      Write-Host "Processing added XML files: $added_files"
      python samreglib/utils/processXML/processXML.py $added_files
      foreach ($file in $added_files) {
        git rm $file
        $json_file = $file -replace '\.xml$', '.json'
        if (Test-Path $json_file) {
          git add $json_file
          Write-Host "Added JSON file: $json_file"
        } else {
          Write-Host "JSON file not found: $json_file"
        }
      }
      if (git status --porcelain) {
        git commit -m "Replace XML files with JSON files"
        git push
        Write-Host "Changes committed and pushed."
      } else {
        Write-Host "No changes to commit."
      }
    } else {
      Write-Host "No new XML files added in this commit."
    }
  displayName: 'Process XML Files and Replace with JSON'
