trigger:
  branches:
    include:
      - main
  paths:
    include:
      - samreglib/Samuel/Samuel/plugins/**/*.py

jobs:
  - job: DetectChanges
    steps:
      - task: UsePythonVersion@0
        inputs:
          versionSpec: '3.x'
          addToPath: true
      - script: |
          # Get the list of files changed in the latest commit
          $changedFiles = git diff --name-only HEAD HEAD~1
          
          # Filter to include only .py files in 'samreglib/Samuel/Samuel/plugins/'
          $filteredFiles = $changedFiles | Where-Object { $_ -match '^samreglib/Samuel/Samuel/plugins/.*\.py$' }
          
          # Loop through each filtered file
          foreach ($file in $filteredFiles) {
              # Split the file path into parts using '/' as the delimiter
              $pathParts = $file -split '/'
              
              # Find the index of 'plugins' in the path
              $pluginsIndex = $pathParts.IndexOf('plugins')
              
              # Check if 'plugins' exists and thereâ€™s a folder after it
              if ($pluginsIndex -ge 0 -and $pluginsIndex + 1 -lt $pathParts.Count) {
                  # Extract the folder name immediately following 'plugins/'
                  $folder = $pathParts[$pluginsIndex + 1]
                  
                  # Run the Python script with the folder name as an argument
                  python samreglib/utils/regressionTest/getMethodeTest.py $folder
                  
                  # Check if the Python script executed successfully
                  if ($LASTEXITCODE -ne 0) {
                      Write-Error "Python script failed for folder $folder"
                  }
              }
          }
        displayName: 'Run script for each changed .py file'
